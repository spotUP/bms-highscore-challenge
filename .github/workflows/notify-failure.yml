name: Notify CI Failure

on:
  workflow_run:
    workflows: ["npm audit (high/critical)", "Storage Policies Audit", "RLS Verification"]
    types:
      - completed

jobs:
  notify-failure:
    if: >-
      (github.event.workflow_run.conclusion == 'failure' ||
       github.event.workflow_run.conclusion == 'cancelled') &&
      github.event.workflow_run.event != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack/Discord
        uses: actions/github-script@v8
        with:
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const workflowName = context.payload.workflow_run.name;
            const workflowUrl = context.payload.workflow_run.html_url;
            const commitSha = context.payload.workflow_run.head_sha.substring(0, 7);
            const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${context.payload.workflow_run.head_sha}`;
            const branch = context.payload.workflow_run.head_branch;
            const conclusion = context.payload.workflow_run.conclusion;
            const statusEmoji = conclusion === 'cancelled' ? 'ðŸŸ¡' : 'ðŸ”´';
            
            // Customize this payload for your webhook
            const payload = {
              text: `${statusEmoji} Workflow *${workflowName}* ${conclusion} in *${repo.full_name}*`,
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `${statusEmoji} *${workflowName}* \n` +
                          `*Status:* ${conclusion.toUpperCase()}\n` +
                          `*Branch:* ${branch} (\`${commitSha}\`)\n` +
                          `*Workflow:* <${workflowUrl}|View run> | <${commitUrl}|View commit>`
                  }
                }
              ]
            };
            
            // Uncomment and set your webhook URL in repo secrets (SLACK_WEBHOOK_URL or DISCORD_WEBHOOK_URL)
            const webhookUrl = process.env.SLACK_WEBHOOK_URL || process.env.DISCORD_WEBHOOK_URL;
            if (webhookUrl) {
              await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
            } else {
              console.log('No webhook URL configured. Set SLACK_WEBHOOK_URL or DISCORD_WEBHOOK_URL in secrets.');
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL || '' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
