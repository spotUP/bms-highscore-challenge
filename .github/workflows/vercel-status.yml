name: Report Vercel Deploy Status

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  report-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check required secrets
        id: check_secrets
        run: |
          missing=0
          for var in VERCEL_TOKEN VERCEL_PROJECT_ID; do
            if [ -z "${{ secrets[format('{0}', var)] }}" ]; then
              echo "::warning::Missing required secret: $var"
              missing=1
            fi
          done
          echo "missing=$missing" >> $GITHUB_OUTPUT
      - name: Exit if missing secrets
        if: steps.check_secrets.outputs.missing == '1'
        run: |
          echo "::notice::Skipping status polling because VERCEL_TOKEN and/or VERCEL_PROJECT_ID are not set as GitHub Secrets."
          exit 0

      - name: Determine context
        id: ctx
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          SHA="${{ github.sha }}"
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi

      - name: Poll Vercel for deployment
        id: poll
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          SHA: ${{ steps.ctx.outputs.sha }}
        run: |
          echo "Polling Vercel for deployment of commit $SHA"
          ATTEMPTS=40
          SLEEP=10
          DEPLOYMENT_JSON=""
          for i in $(seq 1 $ATTEMPTS); do
            # Try filtering by GitHub commit sha metadata
            RESP=$(curl -fsS -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v13/deployments?projectId=$VERCEL_PROJECT_ID&meta-githubCommitSha=$SHA&limit=1") || true
            COUNT=$(echo "$RESP" | jq -r '.deployments | length' 2>/dev/null || echo 0)
            if [ "$COUNT" -gt 0 ]; then
              DEPLOYMENT_JSON=$(echo "$RESP" | jq -r '.deployments[0]')
              STATE=$(echo "$DEPLOYMENT_JSON" | jq -r '.state')
              URL=$(echo "$DEPLOYMENT_JSON" | jq -r '.url')
              echo "Found deployment state=$STATE url=$URL"
              if [ "$STATE" = "READY" ] || [ "$STATE" = "ERROR" ] || [ "$STATE" = "CANCELED" ]; then
                echo "state=$STATE" >> $GITHUB_OUTPUT
                echo "url=https://$URL" >> $GITHUB_OUTPUT
                break
              fi
            fi
            echo "Not ready yet (attempt $i/$ATTEMPTS). Sleeping $SLEEP s..."
            sleep $SLEEP
          done
          # If still empty
          if [ -z "$(echo "$DEPLOYMENT_JSON" | jq -r '.uid // empty')" ]; then
            echo "::warning::No deployment found for commit $SHA in allotted time."
            echo "state=UNKNOWN" >> $GITHUB_OUTPUT
            echo "url=" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with deployment status
        if: steps.ctx.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.ctx.outputs.pr_number }}
          STATE: ${{ steps.poll.outputs.state }}
          URL: ${{ steps.poll.outputs.url }}
          SHA: ${{ steps.ctx.outputs.sha }}
        run: |
          TITLE="Vercel deployment for $SHA: $STATE"
          BODY="Deployment state: **$STATE**\n\nURL: ${URL:-N/A}"
          gh pr comment "$PR_NUMBER" --body "$TITLE

$BODY" || echo "::warning::Failed to comment on PR"

      - name: Log deployment status (push to main)
        if: steps.ctx.outputs.pr_number == ''
        run: |
          echo "Deployment state: ${{ steps.poll.outputs.state }}"
          echo "URL: ${{ steps.poll.outputs.url }}"
